<!DOCTYPE html>
<html>
   <head>
      <title>ESP Firmware Flasher</title>
      <style>
         body {
         background-color: #1a1a1a;
         color: #fff;
         font-family: Arial, sans-serif;
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         height: 100vh;
         margin: 0;
         }
         /* Add the styles for the new button here */
         .action-buttons {
         position: fixed;
         top: 10px;
         right: 10px;
         display: flex;
         gap: 10px;
         }
         .action-button {
         display: block;
         padding: 10px 20px;
         background-color: #FFA500; /* Orange color for the Flush All Devices button */
         color: #fff;
         border: none;
         cursor: pointer;
         border-radius: 4px;
         transition: background-color 0.3s;
         }
         .action-button.logout-btn {
         background-color: #f44336; /* Red color for the Logout button */
         }
         .action-button.flush-btn {
         background-color: #FFA500; /* Orange color for the Flush All Devices button */
         }
         .action-button.show-all-btn {
         background-color: #4CAF50; /* Green color for the Show All Devices button */
         }
         .action-button:hover {
         background-color: #d32f2f; /* Darker red shade on hover */
         }
         .action-button.flush-btn:hover {
         background-color: #FF8C00; /* Darker shade of orange on hover */
         }
         .action-button.show-all-btn:hover {
         background-color: #45a049; /* Darker shade of green on hover */
         }
         .container {
         display: flex;
         justify-content: center;
         width: 80%;
         max-width: 1000px;
         padding: 20px;
         border: 2px solid #ccc;
         }
         .left-container,
         .right-container {
         flex: 1;
         text-align: center;
         }
         .left-container {
         margin-right: 20px;
         border-right: 2px solid #ccc;
         padding-right: 20px;
         display: flex;
         flex-direction: column;
         align-items: center;
         justify-content: center;
         }
         .right-container {
         margin-left: 20px;
         padding-left: 20px;
         }
         h1 {
         margin-bottom: 20px;
         }
         label {
         display: block;
         margin-bottom: 10px;
         }
         input[type="file"] {
         display: none;
         }
         .upload-btn {
         display: inline-block;
         padding: 10px 20px;
         background-color: #4CAF50;
         color: #fff;
         border: none;
         cursor: pointer;
         border-radius: 4px;
         transition: background-color 0.3s;
         }
         .upload-btn:hover {
         background-color: #45a049;
         }
         #espList {
         display: block;
         width: 200px;
         margin-bottom: 20px;
         }
         .flash-btn {
         display: inline-block;
         padding: 10px 20px;
         background-color: #2196F3; /* Blue color for the Flash Firmware button */
         color: #fff;
         border: none;
         cursor: pointer;
         border-radius: 4px;
         transition: background-color 0.3s;
         margin-bottom: 10px;
         }
         .flash-btn:hover {
         background-color: #1e87db; /* Darker blue shade on hover */
         }
         .device-info {
         margin: 10px;
         padding: 10px;
         border: 1px solid #ccc;
         border-radius: 4px;
         display: inline-block;
         }
         .online {
         color: #4CAF50;
         }
         .offline {
         color: #F44336;
         }
         /* New styles for "Show All Devices" button and layer */
         .show-all-btn {
         background-color: #4CAF50; /* Green color for the Show All Devices button */
         display: block;
         padding: 10px 20px;
         color: #fff;
         border: none;
         cursor: pointer;
         border-radius: 4px;
         transition: background-color 0.3s;
         }
         .show-all-btn:hover {
         background-color: #45a049; /* Darker shade of green on hover */
         }
         .devices-layer {
         display: none;
         position: fixed;
         top: 0;
         left: 0;
         width: 100%;
         height: 100%;
         background-color: rgba(0, 0, 0, 0.7);
         z-index: 999;
         padding: 20px;
         }
         .devices-layer .devices-container {
         max-height: 80%;
         overflow-y: auto;
         }
         /* New styles for the Close button */
         .devices-layer button {
         display: inline-block;
         padding: 10px 20px;
         background-color: #f44336; /* Red color for the Close button */
         color: #fff;
         border: none;
         cursor: pointer;
         border-radius: 4px;
         transition: background-color 0.3s;
         }
         .devices-layer button:hover {
         background-color: #d32f2f; /* Darker red shade on hover */
         }
         .device-info p {
         margin: 5px 0;
         }
         .signal-strength {
         color: #FFC107;
         }
         /* Media Query for mobile view */
         @media screen and (max-width: 600px) {
         .container {
         flex-direction: column;
         align-items: stretch;
         }
         .left-container,
         .right-container {
         border: none;
         padding: 0;
         margin: 0;
         text-align: center;
         }
         .right-container {
         margin-top: 20px;
         }
         .upload-btn,
         .flash-btn {
         width: 100%;
         padding: 12px;
         margin-bottom: 10px;
         }
         #espList {
         width: 100%;
         margin-bottom: 10px;
         }
         .show-all-btn {
         display: block;
         width: 100%;
         }
         .devices-layer {
         padding: 10px;
         }
         }
      </style>
   </head>
   <body>
      <div class="action-buttons">
         <!-- The beautiful radio buttons (swapped) -->
         <label class="action-button flush-btn" onclick="promptPasswordAndFlushAll()">Flush All Devices</label>
         <label class="action-button show-all-btn" onclick="toggleRegisteredDevices()">Show All Devices</label>
         <label class="action-button logout-btn" onclick="logout()">Logout</label>
      </div>
      <div class="container">
         <div class="left-container">
            <h1>ESP Firmware Flasher</h1>
            <label for="firmware">Select Firmware:</label>
            <label class="upload-btn" for="firmware">Upload Firmware</label>
            <input type="file" id="firmware" name="firmwareFile" accept=".bin"><br>
            <label for="espList">Select ESP:</label>
            <select id="espList" onchange="fetchFirmwareVersion()">
               <option value="">Select an ESP</option>
            </select>
            <br>
            <label id="firmwareVersion">Firmware Version: N/A</label><br>
            <button class="flash-btn" onclick="promptPasswordAndFlash()">Flash Firmware</button>
            <div id="flashMessageContainer"></div>
         </div>
         <div class="right-container">
            <h2>Registered Devices:</h2>
            <div>
               <p>Total Registered Devices: <span id="totalDevicesCount">0</span></p>
               <p>Online Devices: <span id="onlineDevicesCount">0</span></p>
               <p>Offline Devices: <span id="offlineDevicesCount">0</span></p>
            </div>
            <div id="deviceList">
               <!-- Device status and firmware version will be dynamically added here -->
            </div>
            <div class="devices-layer" id="devicesLayer">
               <!-- The layer to show all registered devices will be dynamically added here -->
               <div class="devices-container">
                  <!-- Dynamically display all registered devices here -->
               </div>
               <button onclick="toggleRegisteredDevices()">Close</button>
            </div>
         </div>
      </div>
      <p id="serverVersion">Server Version: Loading...</p>
      <!-- Add the GitHub link -->
      <a href="https://github.com/ErfanDL/ESP_OTA_Dashboard">GitHub</a>
      <script>
         const flashMessageContainer = document.getElementById('flashMessageContainer');
         
         // Function to display the "OTA" message for 5 seconds and then remove it
         function displayFlashMessage(message) {
           flashMessageContainer.textContent = message;
           setTimeout(() => {
             flashMessageContainer.textContent = '';
           }, 5000); // Remove the message after 5000 milliseconds (5 seconds)
         }
         
         fetch('/getWebSocketAddress')
           .then(response => response.json())
           .then(data => {
             const wsAddress = `ws://${data.ip}:${data.port}`;
             const ws = new WebSocket(wsAddress);
         
             ws.onmessage = (event) => {
               const message = event.data;
               displayFlashMessage(message); // Display the received message
             };
           })
                // Function to fetch registered ESP devices and populate the dropdown list
                function fetchRegisteredDevices() {
                    fetch('/getDevices')
                        .then(response => response.json())
                        .then(data => {
                            const espList = document.getElementById('espList');
                            espList.innerHTML = '<option value="">Select an ESP</option>'; // Clear existing list and add the default option
                            data.forEach(device => {
                                const option = document.createElement('option');
                                option.value = device;
                                option.text = device;
                                espList.appendChild(option);
                            });
                        })
                        .catch(error => console.error('Error fetching devices:', error));
                }
                
                // Function to fetch firmware version for the selected ESP
                function fetchFirmwareVersion() {
                    const selectedESP = espList.value;
                    if (!selectedESP) {
                        return;
                    }
                
                    fetch('/getFirmwareVersion?hostName=' + encodeURIComponent(selectedESP))
                        .then(response => response.text())
                        .then(version => {
                            const firmwareVersionLabel = document.getElementById('firmwareVersion');
                            firmwareVersionLabel.innerText = 'Firmware Version: ' + version;
                        })
                        .catch(error => console.error('Error fetching firmware version:', error));
                }
                
                // Function to upload firmware to the Node.js server and initiate firmware flashing
                function uploadAndFlashFirmware() {
                    const fileInput = document.getElementById('firmware');
                    const selectedFile = fileInput.files[0];
                    if (!selectedFile) {
                        alert('Please select a firmware file.');
                        return;
                    }
                
                    const formData = new FormData();
                    formData.append('firmwareFile', selectedFile);
                
                    const selectedESP = espList.value;
                    if (!selectedESP) {
                        alert('Please select an ESP from the list.');
                        return;
                    }
                
                    fetch('/upload?hostName=' + encodeURIComponent(selectedESP), {
                        method: 'POST',
                        body: formData
                    })
                        .then(response => {
                            if (response.ok) {
                                alert('Firmware upload successful. Starting OTA update...');
                                fetch('/flash-firmware?hostName=' + encodeURIComponent(selectedESP))
                                    .then(response => {
                                        if (response.ok) {
                                        } else {
                                        }
                                    })
                                    .catch(error => console.error('Error initiating firmware flashing:', error));
                            } else {
                                alert('Firmware upload failed.');
                            }
                        })
                        .catch(error => console.error('Error uploading firmware:', error));
                }
                
                // Function to fetch online status and firmware version for all registered devices
                function fetchDeviceStatus() {
                    fetch('/getOnlineStatus')
                        .then(response => response.json())
                        .then(deviceStatusList => {
                            const deviceList = document.getElementById('deviceList');
                            const totalDevicesCount = document.getElementById('totalDevicesCount');
                            const onlineDevicesCount = document.getElementById('onlineDevicesCount');
                            const offlineDevicesCount = document.getElementById('offlineDevicesCount');
                
                            deviceList.innerHTML = ''; // Clear existing list
                
                            const defaultDeviceLimit = 6;
                            let deviceCounter = 0;
                            let onlineCounter = 0;
                            let offlineCounter = 0;
                
                            deviceStatusList.forEach(deviceStatus => {
                                if (deviceCounter < defaultDeviceLimit) {
                                    appendDeviceInfo(deviceList, deviceStatus);
                                }
                                deviceCounter++;
                
                                if (deviceStatus.online) {
                                    onlineCounter++;
                                } else {
                                    offlineCounter++;
                                }
                            });
                
                            totalDevicesCount.innerText = deviceCounter;
                            onlineDevicesCount.innerText = onlineCounter;
                            offlineDevicesCount.innerText = offlineCounter;
                
                            const showAllBtn = document.querySelector('.show-all-btn');
                            if (deviceCounter > defaultDeviceLimit) {
                                showAllBtn.style.display = 'block';
                            } else {
                            }
                        })
                        .catch(error => console.error('Error fetching device status:', error));
                }
                
                // Function to append device information to the deviceList div
                function appendDeviceInfo(deviceList, deviceStatus) {
                    const deviceInfo = document.createElement('div');
                    deviceInfo.classList.add('device-info');
                    deviceInfo.innerHTML = `
                        <p>Device: ${deviceStatus.device}</p>
                        <p>Status: <span class="${deviceStatus.online ? 'online' : 'offline'}">${deviceStatus.online ? 'Online' : 'Offline'}</span></p>
                        <p>Firmware Version: ${deviceStatus.firmwareVersion}</p>
                        <p>Signal: <span class="signal-strength">${deviceStatus.wifiSignalStrength !== undefined ? deviceStatus.wifiSignalStrength : 'N/A'}</span></p>
                        <p>MAC: ${deviceStatus.macAddress}</p>
                        <p>IP Address: ${deviceStatus.ipAddress !== undefined ? deviceStatus.ipAddress : 'N/A'}</p>
                    `;
                    deviceList.appendChild(deviceInfo);
                }
                
                // Function to toggle the devices layer visibility
                function toggleRegisteredDevices() {
                const devicesLayer = document.getElementById('devicesLayer');
                const showAllBtn = document.querySelector('.show-all-btn');
                
                if (devicesLayer.style.display === 'block') {
                devicesLayer.style.display = 'none';
                } else {
                devicesLayer.style.display = 'block';
                }
                }
                
                
                // Function to populate the devices layer with all registered devices and refresh every 10 seconds
                function populateDevicesLayer() {
                    const devicesLayer = document.getElementById('devicesLayer');
                    devicesLayer.innerHTML = `
                        <div class="devices-container">
                            <!-- Dynamically display all registered devices here -->
                        </div>
                        <button onclick="toggleRegisteredDevices()">Close</button>
                    `;
                
                    const devicesContainer = devicesLayer.querySelector('.devices-container');
                
                    // Function to update the devices layer with device information
                    function updateDevicesLayer() {
                        fetch('/getOnlineStatus')
                            .then(response => response.json())
                            .then(deviceStatusList => {
                                devicesContainer.innerHTML = ''; // Clear existing list
                                deviceStatusList.forEach(deviceStatus => {
                                    appendDeviceInfo(devicesContainer, deviceStatus);
                                });
                            })
                            .catch(error => console.error('Error fetching device status:', error));
                    }
                
                    // Call the updateDevicesLayer function initially
                    updateDevicesLayer();
                
                    // Set interval to update the devices layer every 10 seconds
                    setInterval(updateDevicesLayer, 10000);
                }
                         // Function to prompt password and flash firmware
                function promptPasswordAndFlash() {
                   const password = prompt('Enter password:'); // Prompt the user for password
                
                   if (password === null || password === '') {
                      // User canceled or entered an empty password
                      return;
                   }
                
                   // Send the password to the Node.js server for authentication
                   fetch('/authenticate', {
                      method: 'POST',
                      headers: {
                         'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ password: password })
                   })
                   .then(response => {
                      if (response.ok) {
                         // Password is correct, proceed with firmware flashing
                         uploadAndFlashFirmware();
                      } else {
                         // Password is incorrect, show an error message
                         alert('Incorrect password. Firmware flashing canceled.');
                      }
                   })
                   .catch(error => console.error('Error authenticating password:', error));
                }
                // Function to prompt password and flush all devices
                function promptPasswordAndFlushAll() {
                   const password = prompt('Enter password:'); // Prompt the user for password
                
                   if (password === null || password === '') {
                      // User canceled or entered an empty password
                      return;
                   }
                
                   // Send the password to the Node.js server for authentication
                   fetch('/authenticate', {
                      method: 'POST',
                      headers: {
                         'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ password: password })
                   })
                   .then(response => {
                      if (response.ok) {
                         // Password is correct, proceed with flushing all devices
                         flushAllDevices();
                      } else {
                         // Password is incorrect, show an error message
                         alert('Incorrect password. Flushing all devices canceled.');
                      }
                   })
                   .catch(error => console.error('Error authenticating password:', error));
                }
                // Function to prompt password and flush all devices
                function promptPasswordAndFlushAll() {
                   const password = prompt('Enter password:'); // Prompt the user for password
                
                   if (password === null || password === '') {
                      // User canceled or entered an empty password
                      return;
                   }
                
                   // Send the password to the Node.js server for authentication
                   fetch('/authenticate', {
                      method: 'POST',
                      headers: {
                         'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({ password: password })
                   })
                   .then(response => {
                      if (response.ok) {
                         // Password is correct, proceed with flushing all devices
                         flushAllDevices();
                      } else {
                         // Password is incorrect, show an error message
                         alert('Incorrect password. Flushing all devices canceled.');
                      }
                   })
                   .catch(error => console.error('Error authenticating password:', error));
                }
                // Call the fetchRegisteredDevices and fetchDeviceStatus functions on page load
                fetchRegisteredDevices();
                fetchDeviceStatus();
                
                // Set interval to update device status every 10 seconds
                setInterval(fetchDeviceStatus, 10000);
                
                   // Function to flush all registered devices
                function flushAllDevices() {
                   fetch('/flushAllDevices', {
                      method: 'POST'
                   })
                   .then(response => {
                      if (response.ok) {
                         alert('All registered devices have been flushed.');
                         fetchRegisteredDevices();
                         fetchDeviceStatus();
                      } else {
                         alert('Failed to flush registered devices.');
                      }
                   })
                   .catch(error => console.error('Error flushing registered devices:', error));
                }
                
                // Call the function to populate the devices layer when the page loads
                populateDevicesLayer();
                function logout() {
                    fetch('/logout', {
                        method: 'POST'
                    })
                        .then(response => {
                            if (response.ok) {
                                window.location.href = '/'; // Redirect to the login page
                            }
                        })
                        .catch(error => console.error('Error logging out:', error));
                }
         // Add a function to fetch the server version and display it on the page
         async function fetchServerVersion() {
         try {
         const response = await fetch('/getServerVersion');
         if (response.ok) {
         const serverVersion = await response.text();
         const versionElement = document.getElementById('serverVersion');
         versionElement.textContent = `Server Version: ${serverVersion}`;
         } else {
         console.error('Failed to fetch server version:', response.status, response.statusText);
         }
         } catch (error) {
         console.error('Error fetching server version:', error.message);
         }
         }
         
         // Call the fetchServerVersion function when the page is loaded
         document.addEventListener('DOMContentLoaded', fetchServerVersion);
             
      </script>
   </body>
</html>